{% extends "base.html" %}
{% block dynamic %}
<div class="container-fluid">
    <div class="d-sm-flex justify-content-between align-items-center mb-4">
        <h3 class="text-dark mb-0">Admins <span class="badge badge-info badge-counter" id="total-admins-badge"></span></h3></div>
    <div class="row">
        <div class="col-md-12">
                <table id="admin" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
        </div>
    </div>
    
<div class="row">
    <div class="col-lg-6 mb-4">
        
        
    </div>
    <div class="col">
        <div class="row">
            
        </div>
    </div>
</div>
</div>
</div>
{%endblock%}

{% block extra_js %}
<script>
    $(document).ready(function() {
        var stored_response = JSON.parse(localStorage.getItem('response'));
        if (stored_response.superuser){
            var columns = [
                { title: "Name"},
                { title: "Username" },
                { title: "Added On" },
                { title: "Status" },
                { title: "Organization Name" },
                { title: "Assign Device" }
            ]
        }
        else{
            var columns = [
                { title: "Name"},
                { title: "Username" },
                { title: "Added On" },
                { title: "Status" },
                { title: "Organization Name" },
            ]
        }
        var table = $('#admin').DataTable({
            columns: columns,
        });

        var datas = []
        var users = JSON.parse(localStorage.getItem('users'));
        $('#total-admins-badge').text('Total Admins: ' + users.length);
        users.forEach(function(dd){
            temp_data = []
            temp_data.push(dd.first_name + ' ' + dd.last_name);
            temp_data.push(dd.username);
            temp_data.push(dd.date_joined);
            temp_data.push(dd.is_active);
            temp_data.push(dd.organization_name)
            if (stored_response.superuser){
                temp_data.push(`<button type="button" class="btn btn-dark" onclick="assignDevice('${dd.topic}', ${dd.id}, '${dd.subject_name}');">Assign Device</button>`)
            }
            datas.push(temp_data);
        });
        table.rows.add(datas).draw();
    });

    function populateDataTable(data) {
        console.log("populating data table...");
        // clear the table before populating it with more data
        $("#admin").DataTable().clear();
        var length = Object.keys(data.customers).length;
        for(var i = 1; i < length+1; i++) {
        var customer = data.customers['customer'+i];

        // You could also use an ajax property on the data table initialization
        $('#admin').dataTable().fnAddData([
            customer.first_name + customer.last_name,
            customer.username,
            customer.date_joined,
            customer.is_active,
            customer.organization_name
        ]);
        }
    }

    function assignDevice(topic, id) {
        var device_name = window.prompt("Device name given to : ");
        if (device_name == ''){
            alert("You have to give a name to device");
        }
        else{
            $.ajax({
                url: '/api/device/',
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Access-Control-Allow-Origin": "*",
                    "Authorization": "Bearer " + localStorage.getItem("token"),
                },
                data: JSON.stringify({
                    "topic": topic,
                    "message": "Device assigned",
                    "name": device_name,
                    "belongs_to": id,
                    "status": false
                }),
                success: function(data, status){
                    alert(status);
                },
                error: function(data, status, error){
                    alert(error);
                }
            })
        }
    }
    
</script>
{%endblock%}